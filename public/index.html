<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>lol league</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='style/style.css'>
</head>

<body>
  <script src="render-form.js"></script>
  <div id="logos">
    <img src="assets/images/alexa.png">
  </div>
  <h1 style="text-align: center; color: #CDBE91;" id="page-title"></h1>
  <div id="ui-data">
  </div>

  <div id="amazon-root"></div>
  <div id="ui-data">
  </div>
  <script src="get-consts.js"></script>
  <script src="render-form.js"></script>
  <script type="text/javascript">

    let translationPack;
    async function loadI18N() {
      const language = navigator.language;
      let url = "/i18n/"
      if (/^pt\b/.test(navigator.language)) {
        url += "pt-br.json";
      } else {
        url += "en.json";
      }
      const request = await fetch(url)
      const data = await request.json();
      return data;
    }

    async function getLoggedUserData(jwt) {
      const response = await fetch(`/leagueData?jwt=${jwt}`);
      const json = await response.json();
      return json;
    }

    async function saveLoggedUserData(jwt, data) {
      const response = await fetch(`/leagueData?jwt=${jwt}`, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-type": "application/json"
        }
      });
      const json = await response.json();
      return json;
    }

    function createLoggedUserForm(jwt, data) {
      renderForm(
        (_) => onButtonClicked(jwt),
        data.nickname,
        data.region,
        translationPack,
      );
    }

    async function onButtonClicked(jwt) {

      const $button = document.querySelector("#league-button");
      $button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: rgb(32, 45, 53); display: block;" width="34px" height="34px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
          <circle cx="50" cy="50" fill="none" stroke="#e9d972" stroke-width="3" r="35" stroke-dasharray="164.93361431346415 56.97787143782138">
            <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
          </circle>
        </svg>`

      const $errorIndicator = document.querySelector("#error-indicator")
      const $sucessIndicator = document.querySelector("#sucess-indicator")
      
      $errorIndicator.innerHTML = "";
      $sucessIndicator.innerHTML = "";
      const payload = {
        nickname: document.querySelector("#nickname").value,
        region: document.querySelector("#region").value,
      }
      const data = await saveLoggedUserData(jwt, payload)
      console.log(data);
      if(data.code || data.message) {
        $errorIndicator.innerHTML = translationPack[data.code] || data.message;
      } else {
        $sucessIndicator.innerHTML = translationPack["SUMMONER_NICKNAME_SAVED"];
      }
      $button.innerHTML = getSubmitButtonHtml(translationPack["SAVE"]);
    }

    function createLoginButton(constants) {
      const $uiData = document.querySelector(
        "#ui-data"
      );
      $uiData.innerHTML = `
        <a href id="LoginWithAmazon">
        <img border="0" alt="${translationPack["AMAZON_LOGIN"]}"
          src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png" width="156" height="32" />
        </a>
      `
      const $loginButton = document.getElementById('LoginWithAmazon');
      $loginButton.onclick = async function (e) {
        e.preventDefault();
        $loginButton.style.display = "none";

        options = {}
        options.popup = false;
        options.scope = 'profile:user_id';
        options.response_type = 'code';
        amazon.Login.authorize(
          options,
          constants.redirectUri
        );
        return false;
      }
    }

    async function load() {
      try {
        translationPack = await loadI18N();
        document.querySelector("title").innerText = translationPack["TITLE"];
        document.querySelector("#page-title").innerHTML = translationPack["TITLE"];

        const jwt = localStorage.getItem("jwt");
        if(jwt) {
          const data = await getLoggedUserData(jwt);
          createLoggedUserForm(jwt, data);
        } else {
          const constants = await getConstants();
          configureAmazonSdk(constants);
          createLoginButton(constants);
        }
      } catch (e) {
        const $uiData = document.querySelector(
          "#ui-data"
        );
        $uiData.innerHTML = `
          <h3>${translationPack["UNHANDLED_ERROR_MESSAGE"]}</h3>
          <div style="width: 100%"></div>
          <h3 style="color: red; margin: 0;">${translationPack["ERROR_OCCURRED"]}</h3>
        `;
      }
    };
    
    function configureAmazonSdk(constants) {
      window.onAmazonLoginReady = function () {
        amazon.Login.setClientId(constants.clientId);
      };
      
      (function (d) {
        var a = d.createElement('script'); a.type = 'text/javascript';
        a.async = true; a.id = 'amazon-login-sdk';
        a.src = 'https://assets.loginwithamazon.com/sdk/na/login1.js';
        d.getElementById('amazon-root').appendChild(a);
      })(document);
    }
    
    load();
  </script>
</body>

</html>